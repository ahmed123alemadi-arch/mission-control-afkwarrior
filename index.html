<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - AFKwarrior</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mission Control">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="description" content="Real-time monitoring for AFKwarrior squad">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e17;
            color: #e4e4e7;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #161b26;
            border-radius: 12px;
        }

        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .timestamp {
            color: #71717a;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #161b26;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #27272a;
        }

        .stat-label {
            color: #71717a;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-value.green { color: #22c55e; }
        .stat-value.orange { color: #f59e0b; }
        .stat-value.blue { color: #3b82f6; }
        .stat-value.purple { color: #a855f7; }

        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e4e4e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-count {
            font-size: 14px;
            color: #71717a;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .agent-card {
            background: #161b26;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #27272a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-icon {
            font-size: 28px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .agent-role {
            font-size: 12px;
            color: #71717a;
        }

        .agent-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-online {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-working {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-idle {
            background: rgba(113, 113, 122, 0.2);
            color: #71717a;
        }

        .cron-list {
            background: #161b26;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #27272a;
        }

        .cron-item {
            padding: 12px;
            border-bottom: 1px solid #27272a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cron-item:last-child {
            border-bottom: none;
        }

        .cron-name {
            font-weight: 500;
        }

        .cron-time {
            font-size: 12px;
            color: #71717a;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #71717a;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .info strong {
            color: #60a5fa;
        }

        .info code {
            background: rgba(59, 130, 246, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .refresh-btn {
            background: #f59e0b;
            color: #0a0e17;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #d97706;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <div class="logo">üê∫</div>
            MISSION CONTROL
            <span style="color: #71717a; font-size: 16px; font-weight: 400;">AFKwarrior</span>
        </h1>
        <div>
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
            <div class="timestamp" id="timestamp">Loading...</div>
        </div>
    </div>

    <div id="error-container"></div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Agents Online</div>
            <div class="stat-value green" id="agents-online">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Working</div>
            <div class="stat-value orange" id="agents-working">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-value blue" id="total-sessions">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Cron Jobs</div>
            <div class="stat-value purple" id="cron-jobs">-</div>
        </div>
    </div>

    <div class="section-title">
        Squad Overview
        <span class="agent-count" id="agent-count">17 agents</span>
    </div>
    <div class="agents-grid" id="agents-grid">
        <div class="loading">Loading agents...</div>
    </div>

    <div class="section-title" style="margin-top: 30px;">
        Cron Jobs
    </div>
    <div class="cron-list" id="cron-list">
        <div class="loading">Loading cron jobs...</div>
    </div>

    <script>
        // Auto-detect: Use local gateway if on same network, otherwise show instructions
        const isLocalNetwork = window.location.hostname === 'localhost' || 
                               window.location.hostname === '192.168.100.18' ||
                               window.location.protocol === 'file:';
        
        const GATEWAY_URL = isLocalNetwork ? 'http://192.168.100.18:18789' : null;
        const GATEWAY_TOKEN = 'b4d3a4a9d4a022886922fae7ac3e979a4bbff7fcc744b947';

        const AGENT_DEFINITIONS = [
            { id: 'main', name: 'Joseph', emoji: 'üê∫', role: 'Chief Orchestrator' },
            { id: 'sysops-mac', name: 'Guardian', emoji: 'üõ°Ô∏è', role: 'Mac SysOps' },
            { id: 'sysops-win', name: 'Sentinel', emoji: 'üî∞', role: 'Windows SysOps' },
            { id: 'researcher', name: 'Scout', emoji: 'üîç', role: 'Research Specialist' },
            { id: 'builder', name: 'Forge', emoji: '‚öíÔ∏è', role: 'Core Developer' },
            { id: 'marketer', name: 'Blaze', emoji: 'üî•', role: 'Growth Strategist' },
            { id: 'writer', name: 'Ink', emoji: '‚úçÔ∏è', role: 'Content Writer' },
            { id: 'retention', name: 'Grip', emoji: 'üìä', role: 'Retention Specialist' },
            { id: 'artdirector', name: 'Pixel', emoji: 'üé®', role: 'Art Director' },
            { id: 'customerresearch', name: 'Echo', emoji: 'üïµÔ∏è', role: 'Customer Research' },
            { id: 'socialmedia', name: 'Buzz', emoji: 'üì±', role: 'Social Media Manager' },
            { id: 'qa', name: 'Shield', emoji: 'üß™', role: 'QA Tester' },
            { id: 'localization', name: 'Atlas', emoji: 'üåê', role: 'Localization' },
            { id: 'audio', name: 'Rhythm', emoji: 'üéµ', role: 'Audio Director' },
            { id: 'monetization', name: 'Vault', emoji: 'üí∞', role: 'Monetization' },
            { id: 'analytics', name: 'Pulse', emoji: 'üìà', role: 'Analytics' },
            { id: 'community', name: 'Vibe', emoji: 'ü§ù', role: 'Community' }
        ];

        async function fetchSessions() {
            if (!GATEWAY_URL) {
                throw new Error('Gateway not accessible from public internet. Please use local network access: http://192.168.100.18:8080');
            }
            
            const response = await fetch(`${GATEWAY_URL}/api/sessions/list`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GATEWAY_TOKEN}`
                },
                body: JSON.stringify({ limit: 50 })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        function getAgentStatus(sessions, agentId) {
            // Find most recent session for this agent
            const agentSessions = sessions.filter(s => 
                s.key.includes(agentId) || s.key === `agent:${agentId}:main`
            );
            
            if (agentSessions.length === 0) return 'idle';
            
            // Sort by updatedAt, most recent first
            agentSessions.sort((a, b) => b.updatedAt - a.updatedAt);
            const latest = agentSessions[0];
            
            // Check if recently active (within last 5 minutes)
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            if (latest.updatedAt > fiveMinutesAgo) {
                return 'working';
            }
            
            return 'online';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        }

        async function loadData() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = '';
            
            try {
                const data = await fetchSessions();
                const sessions = data.sessions || [];
                
                // Update timestamp
                document.getElementById('timestamp').textContent = 
                    new Date().toLocaleTimeString('en-US', { hour12: false });
                
                // Count agents by status
                const agentStatuses = AGENT_DEFINITIONS.map(agent => ({
                    ...agent,
                    status: getAgentStatus(sessions, agent.id)
                }));
                
                const online = agentStatuses.filter(a => a.status === 'online').length;
                const working = agentStatuses.filter(a => a.status === 'working').length;
                const cronJobs = sessions.filter(s => s.key.includes(':cron:')).length;
                
                // Update stats
                document.getElementById('agents-online').textContent = online;
                document.getElementById('agents-working').textContent = working;
                document.getElementById('total-sessions').textContent = sessions.length;
                document.getElementById('cron-jobs').textContent = cronJobs;
                
                // Render agents grid
                const agentsGrid = document.getElementById('agents-grid');
                agentsGrid.innerHTML = agentStatuses.map(agent => `
                    <div class="agent-card">
                        <div class="agent-icon">${agent.emoji}</div>
                        <div class="agent-info">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-role">${agent.role}</div>
                        </div>
                        <span class="agent-status status-${agent.status}">${agent.status}</span>
                    </div>
                `).join('');
                
                // Render cron jobs
                const cronSessions = sessions.filter(s => s.key.includes(':cron:'));
                const cronList = document.getElementById('cron-list');
                
                if (cronSessions.length === 0) {
                    cronList.innerHTML = '<div class="loading">No active cron jobs</div>';
                } else {
                    cronList.innerHTML = cronSessions.map(cron => `
                        <div class="cron-item">
                            <div>
                                <div class="cron-name">${cron.label || cron.displayName}</div>
                                <div class="cron-time">Last run: ${formatTime(cron.updatedAt)}</div>
                            </div>
                            <span class="agent-status status-online">active</span>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                
                if (!GATEWAY_URL) {
                    errorContainer.innerHTML = `
                        <div class="info">
                            üì° <strong>Network Access Required</strong><br><br>
                            Mission Control needs to connect to the Gateway API on your local network.<br><br>
                            <strong>To use this dashboard:</strong><br>
                            1Ô∏è‚É£ Connect to the same WiFi as your Mac Mini (192.168.100.x network)<br>
                            2Ô∏è‚É£ Open: <code>http://192.168.100.18:8080</code><br>
                            3Ô∏è‚É£ Add to Home Screen from there<br><br>
                            Or use the local server on your Mac.
                        </div>
                    `;
                } else {
                    errorContainer.innerHTML = `
                        <div class="error">
                            ‚ö†Ô∏è Failed to load data: ${error.message}<br><br>
                            Make sure you're connected to the same network as the Gateway (192.168.100.x)
                        </div>
                    `;
                }
            }
        }

        // Load data on page load
        loadData();
        
        // Auto-refresh every 10 seconds
        setInterval(loadData, 10000);

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
